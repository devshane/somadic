#!/usr/bin/env ruby
require 'optparse'
require 'somadic'

options = { cache: nil,
            cache_min: nil }

@optparser = OptionParser.new do |o|
  o.banner = 'Usage: somadic [options] site channel'
  o.separator ''
  o.separator 'The `site` parameter can be di or soma.'
  o.separator ''
  o.separator 'DI premium channels require an environment variable: DI_FM_PREMIUM_ID.'
  o.separator ''

  o.on('-c CACHE_SIZE', '--cache CACHE_SIZE', 'Set the cache size (KB)') do |c|
    options[:cache] = c
  end
  o.on('-m CACHE_MIN', '--cache-min CACHE_MIN', 'Set the minimum cache threshold (percent)') do |m|
    options[:cache_min] = m
  end
  o.on('-h', '--help', 'Display this message') { puts o; exit }

  o.parse!
end

def usage
  puts @optparser
  puts
  exit
end

if ARGV[0].nil? || ARGV[1].nil?
  usage
end

if ARGV[0] == 'di'
  di = Somadic::Channel::DI.new(ARGV[1], ENV['DI_FM_PREMIUM_ID'])
  di.start
  while true
    sleep 1
  end
elsif ARGV[0] == 'soma'
  soma = Somadic::Channel::Soma.new(ARGV[1])
  soma.start
  while true
    sleep 1
  end
else
  usage
end

#Signal.trap("INT") do |sig|
#  puts
#  exit
#end

